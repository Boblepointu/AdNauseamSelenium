# Common environment for all browser nodes (disable telemetry spam)
x-node-common: &node-common-env
  SE_OTEL_TRACES_EXPORTER: none
  SE_ENABLE_TRACING: false

volumes:
  personas-data:
    driver: local

services:
  # Selenium Hub with increased capacity
  selenium-hub:
    image: selenium/hub:latest
    ports:
      - "4444:4444"
    environment:
      - SE_SESSION_REQUEST_TIMEOUT=300
      - SE_NODE_SESSION_TIMEOUT=300
      - SE_NODE_MAX_SESSIONS=25
      - SE_OTEL_TRACES_EXPORTER=none
      - SE_ENABLE_TRACING=false
      - SE_SESSION_TIMEOUT=300

  # ============================================
  # CHROME NODES (Diverse versions for maximum TLS/HTTP/CSS diversity)
  # ============================================
  
  chrome-95:
    image: selenium/node-chrome:95.0
    depends_on:
      - selenium-hub
    environment:
      - SE_EVENT_BUS_HOST=selenium-hub
      - SE_EVENT_BUS_PUBLISH_PORT=4442
      - SE_EVENT_BUS_SUBSCRIBE_PORT=4443
      - SE_NODE_MAX_SESSIONS=2
      - SE_OTEL_TRACES_EXPORTER=none
      - SE_ENABLE_TRACING=false
    shm_size: 2gb

  chrome-110:
    image: selenium/node-chrome:110.0
    depends_on:
      - selenium-hub
    environment:
      - SE_EVENT_BUS_HOST=selenium-hub
      - SE_EVENT_BUS_PUBLISH_PORT=4442
      - SE_EVENT_BUS_SUBSCRIBE_PORT=4443
      - SE_NODE_MAX_SESSIONS=2
      - SE_OTEL_TRACES_EXPORTER=none
      - SE_ENABLE_TRACING=false
    shm_size: 2gb

  chrome-120:
    image: selenium/node-chrome:120.0
    depends_on:
      - selenium-hub
    environment:
      - SE_EVENT_BUS_HOST=selenium-hub
      - SE_EVENT_BUS_PUBLISH_PORT=4442
      - SE_EVENT_BUS_SUBSCRIBE_PORT=4443
      - SE_NODE_MAX_SESSIONS=2
      - SE_OTEL_TRACES_EXPORTER=none
      - SE_ENABLE_TRACING=false
    shm_size: 2gb

  chrome-125:
    image: selenium/node-chrome:125.0
    depends_on:
      - selenium-hub
    environment:
      - SE_EVENT_BUS_HOST=selenium-hub
      - SE_EVENT_BUS_PUBLISH_PORT=4442
      - SE_EVENT_BUS_SUBSCRIBE_PORT=4443
      - SE_NODE_MAX_SESSIONS=2
      - SE_OTEL_TRACES_EXPORTER=none
      - SE_ENABLE_TRACING=false
    shm_size: 2gb

  chrome-130:
    image: selenium/node-chrome:130.0
    depends_on:
      - selenium-hub
    environment:
      - SE_EVENT_BUS_HOST=selenium-hub
      - SE_EVENT_BUS_PUBLISH_PORT=4442
      - SE_EVENT_BUS_SUBSCRIBE_PORT=4443
      - SE_NODE_MAX_SESSIONS=2
      - SE_OTEL_TRACES_EXPORTER=none
      - SE_ENABLE_TRACING=false
    shm_size: 2gb

  chrome-latest:
    image: selenium/node-chrome:latest
    depends_on:
      - selenium-hub
    environment:
      - SE_EVENT_BUS_HOST=selenium-hub
      - SE_EVENT_BUS_PUBLISH_PORT=4442
      - SE_EVENT_BUS_SUBSCRIBE_PORT=4443
      - SE_NODE_MAX_SESSIONS=2
      - SE_OTEL_TRACES_EXPORTER=none
      - SE_ENABLE_TRACING=false
    shm_size: 2gb

  chrome-beta:
    image: selenium/node-chrome:beta
    depends_on:
      - selenium-hub
    environment:
      - SE_EVENT_BUS_HOST=selenium-hub
      - SE_EVENT_BUS_PUBLISH_PORT=4442
      - SE_EVENT_BUS_SUBSCRIBE_PORT=4443
      - SE_NODE_MAX_SESSIONS=2
      - SE_OTEL_TRACES_EXPORTER=none
      - SE_ENABLE_TRACING=false
    shm_size: 2gb

  chrome-dev:
    image: selenium/node-chrome:dev
    depends_on:
      - selenium-hub
    environment:
      - SE_EVENT_BUS_HOST=selenium-hub
      - SE_EVENT_BUS_PUBLISH_PORT=4442
      - SE_EVENT_BUS_SUBSCRIBE_PORT=4443
      - SE_NODE_MAX_SESSIONS=2
      - SE_OTEL_TRACES_EXPORTER=none
      - SE_ENABLE_TRACING=false
    shm_size: 2gb

  # ============================================
  # FIREFOX NODES (Diverse versions)
  # ============================================

  firefox-98:
    image: selenium/node-firefox:98.0
    depends_on:
      - selenium-hub
    ports:
      - "7900:7900"
    environment:
      - SE_EVENT_BUS_HOST=selenium-hub
      - SE_EVENT_BUS_PUBLISH_PORT=4442
      - SE_EVENT_BUS_SUBSCRIBE_PORT=4443
      - SE_NODE_MAX_SESSIONS=2
      - SE_OTEL_TRACES_EXPORTER=none
      - SE_ENABLE_TRACING=false
    shm_size: 2gb

  firefox-110:
    image: selenium/node-firefox:110.0
    depends_on:
      - selenium-hub
    ports:
      - "7901:7900"
    environment:
      - SE_EVENT_BUS_HOST=selenium-hub
      - SE_EVENT_BUS_PUBLISH_PORT=4442
      - SE_EVENT_BUS_SUBSCRIBE_PORT=4443
      - SE_NODE_MAX_SESSIONS=2
      - SE_OTEL_TRACES_EXPORTER=none
      - SE_ENABLE_TRACING=false
    shm_size: 2gb

  firefox-120:
    image: selenium/node-firefox:120.0
    depends_on:
      - selenium-hub
    ports:
      - "7902:7900"
    environment:
      - SE_EVENT_BUS_HOST=selenium-hub
      - SE_EVENT_BUS_PUBLISH_PORT=4442
      - SE_EVENT_BUS_SUBSCRIBE_PORT=4443
      - SE_NODE_MAX_SESSIONS=2
      - SE_OTEL_TRACES_EXPORTER=none
      - SE_ENABLE_TRACING=false
    shm_size: 2gb

  firefox-130:
    image: selenium/node-firefox:130.0
    depends_on:
      - selenium-hub
    ports:
      - "7903:7900"
    environment:
      - SE_EVENT_BUS_HOST=selenium-hub
      - SE_EVENT_BUS_PUBLISH_PORT=4442
      - SE_EVENT_BUS_SUBSCRIBE_PORT=4443
      - SE_NODE_MAX_SESSIONS=2
      - SE_OTEL_TRACES_EXPORTER=none
      - SE_ENABLE_TRACING=false
    shm_size: 2gb

  firefox-140:
    image: selenium/node-firefox:140.0
    depends_on:
      - selenium-hub
    ports:
      - "7904:7900"
    environment:
      - SE_EVENT_BUS_HOST=selenium-hub
      - SE_EVENT_BUS_PUBLISH_PORT=4442
      - SE_EVENT_BUS_SUBSCRIBE_PORT=4443
      - SE_NODE_MAX_SESSIONS=2
      - SE_OTEL_TRACES_EXPORTER=none
      - SE_ENABLE_TRACING=false
    shm_size: 2gb

  firefox-latest:
    image: selenium/node-firefox:latest
    depends_on:
      - selenium-hub
    ports:
      - "7905:7900"
    environment:
      - SE_EVENT_BUS_HOST=selenium-hub
      - SE_EVENT_BUS_PUBLISH_PORT=4442
      - SE_EVENT_BUS_SUBSCRIBE_PORT=4443
      - SE_NODE_MAX_SESSIONS=2
      - SE_OTEL_TRACES_EXPORTER=none
      - SE_ENABLE_TRACING=false
    shm_size: 2gb

  firefox-beta:
    image: selenium/node-firefox:beta
    depends_on:
      - selenium-hub
    ports:
      - "7906:7900"
    environment:
      - SE_EVENT_BUS_HOST=selenium-hub
      - SE_EVENT_BUS_PUBLISH_PORT=4442
      - SE_EVENT_BUS_SUBSCRIBE_PORT=4443
      - SE_NODE_MAX_SESSIONS=2
      - SE_OTEL_TRACES_EXPORTER=none
      - SE_ENABLE_TRACING=false
    shm_size: 2gb

  firefox-dev:
    image: selenium/node-firefox:dev
    depends_on:
      - selenium-hub
    ports:
      - "7907:7900"
    environment:
      - SE_EVENT_BUS_HOST=selenium-hub
      - SE_EVENT_BUS_PUBLISH_PORT=4442
      - SE_EVENT_BUS_SUBSCRIBE_PORT=4443
      - SE_NODE_MAX_SESSIONS=2
      - SE_OTEL_TRACES_EXPORTER=none
      - SE_ENABLE_TRACING=false
    shm_size: 2gb

  # ============================================
  # EDGE NODES (Diverse versions)
  # ============================================

  edge-114:
    image: selenium/node-edge:114.0
    depends_on:
      - selenium-hub
    environment:
      - SE_EVENT_BUS_HOST=selenium-hub
      - SE_EVENT_BUS_PUBLISH_PORT=4442
      - SE_EVENT_BUS_SUBSCRIBE_PORT=4443
      - SE_NODE_MAX_SESSIONS=2
      - SE_OTEL_TRACES_EXPORTER=none
      - SE_ENABLE_TRACING=false
    shm_size: 2gb

  edge-120:
    image: selenium/node-edge:120.0
    depends_on:
      - selenium-hub
    environment:
      - SE_EVENT_BUS_HOST=selenium-hub
      - SE_EVENT_BUS_PUBLISH_PORT=4442
      - SE_EVENT_BUS_SUBSCRIBE_PORT=4443
      - SE_NODE_MAX_SESSIONS=2
      - SE_OTEL_TRACES_EXPORTER=none
      - SE_ENABLE_TRACING=false
    shm_size: 2gb

  edge-125:
    image: selenium/node-edge:125.0
    depends_on:
      - selenium-hub
    environment:
      - SE_EVENT_BUS_HOST=selenium-hub
      - SE_EVENT_BUS_PUBLISH_PORT=4442
      - SE_EVENT_BUS_SUBSCRIBE_PORT=4443
      - SE_NODE_MAX_SESSIONS=2
      - SE_OTEL_TRACES_EXPORTER=none
      - SE_ENABLE_TRACING=false
    shm_size: 2gb

  edge-130:
    image: selenium/node-edge:130.0
    depends_on:
      - selenium-hub
    environment:
      - SE_EVENT_BUS_HOST=selenium-hub
      - SE_EVENT_BUS_PUBLISH_PORT=4442
      - SE_EVENT_BUS_SUBSCRIBE_PORT=4443
      - SE_NODE_MAX_SESSIONS=2
      - SE_OTEL_TRACES_EXPORTER=none
      - SE_ENABLE_TRACING=false
    shm_size: 2gb

  edge-latest:
    image: selenium/node-edge:latest
    depends_on:
      - selenium-hub
    environment:
      - SE_EVENT_BUS_HOST=selenium-hub
      - SE_EVENT_BUS_PUBLISH_PORT=4442
      - SE_EVENT_BUS_SUBSCRIBE_PORT=4443
      - SE_NODE_MAX_SESSIONS=2
      - SE_OTEL_TRACES_EXPORTER=none
      - SE_ENABLE_TRACING=false
    shm_size: 2gb

  edge-beta:
    image: selenium/node-edge:beta
    depends_on:
      - selenium-hub
    environment:
      - SE_EVENT_BUS_HOST=selenium-hub
      - SE_EVENT_BUS_PUBLISH_PORT=4442
      - SE_EVENT_BUS_SUBSCRIBE_PORT=4443
      - SE_NODE_MAX_SESSIONS=2
      - SE_OTEL_TRACES_EXPORTER=none
      - SE_ENABLE_TRACING=false
    shm_size: 2gb

  edge-dev:
    image: selenium/node-edge:dev
    depends_on:
      - selenium-hub
    environment:
      - SE_EVENT_BUS_HOST=selenium-hub
      - SE_EVENT_BUS_PUBLISH_PORT=4442
      - SE_EVENT_BUS_SUBSCRIBE_PORT=4443
      - SE_NODE_MAX_SESSIONS=2
      - SE_OTEL_TRACES_EXPORTER=none
      - SE_ENABLE_TRACING=false
    shm_size: 2gb

  # ============================================
  # CHROMIUM NODES (Only 'latest' actually exists!)
  # ============================================

  chromium-latest:
    image: selenium/node-chromium:latest
    depends_on:
      - selenium-hub
    environment:
      - SE_EVENT_BUS_HOST=selenium-hub
      - SE_EVENT_BUS_PUBLISH_PORT=4442
      - SE_EVENT_BUS_SUBSCRIBE_PORT=4443
      - SE_NODE_MAX_SESSIONS=2
      - SE_OTEL_TRACES_EXPORTER=none
      - SE_ENABLE_TRACING=false
    shm_size: 2gb

  # REMOVED: chromium-beta and chromium-dev (they don't exist!)
  # If you need more Chromium diversity, just add more Chrome versions instead

  # ============================================
  # BROWSER AUTOMATION INSTANCES (20 instances)
  # ============================================

  # Instance 1 - Chrome variants
  browser-automation-1:
    image: python:3.11-slim
    depends_on:
      - selenium-hub
      - chrome-95
      - chrome-110
      - chrome-120
      - chrome-latest
      - firefox-98
    volumes:
      - ./crawl.py:/app/crawl.py:ro
      - ./persona_manager.py:/app/persona_manager.py:ro
      - ./setup.sh:/app/setup.sh:ro
      - ./websites.txt:/app/websites.txt:ro
      - personas-data:/app/data/personas
    environment:
      - PERSONA_ROTATION_STRATEGY=weighted
      - PERSONA_MAX_AGE_DAYS=30
      - PERSONA_MAX_USES=100
    command:
      - /bin/bash
      - -c
      - |
        apt-get update -qq && apt-get install -y curl -qq
        bash /app/setup.sh